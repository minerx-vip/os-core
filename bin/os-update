#!/bin/bash
set -o errexit
set -o nounset
echoYellow(){
    echo -e "\033[33m$*\033[0m"
}
echoCyan(){
    echo -e "\033[36m$*\033[0m"
}


down_uri="https://minerx-download.oss-cn-shanghai.aliyuncs.com"
source /os/config/rig.conf
backup_down_uri="$down_uri_ip"


##################################################################
## ä¸‹è½½æ–‡ä»¶å¹¶æå–
##################################################################
download_file() {
    local uri=$1
    local version_file="${uri}/VERSION"
    local filename
    local url
    local archive

    # èŽ·å–ç‰ˆæœ¬å·
    local ver=$(curl -s "$version_file" | awk -F= '{print $2}')
    [[ -z "$ver" ]] && return 1
    filename="os-${ver}.tar.gz"
    url="${uri}/${filename}"
    archive="/tmp/${filename}"  # åœ¨è¿™é‡Œç»™ archive èµ‹å€¼

    echoCyan "æœ€æ–°ç‰ˆæœ¬: ${ver}"

    # åˆ é™¤å·²æœ‰çš„ä¸‹è½½æ–‡ä»¶
    sudo rm -f "${archive}"

    # ä¸‹è½½å¹¶ä¿å­˜
    if sudo wget -t 5 -T 20 -c "${url}" -P /tmp/; then
        echoCyan "ä¸‹è½½æˆåŠŸ: ${filename}"
        sudo tar xzf ${archive} -C / || { echoYellow "Install failed!"; exit 1; }
        return 0
    else
        echoYellow "ä¸‹è½½å¤±è´¥: ${filename}"
        return 1
    fi
}

# æ£€æŸ¥ä¸»ä¸‹è½½ URI
if ! download_file "${down_uri}"; then
    # ä¸»ä¸‹è½½å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨ URI
    echoYellow "ä¸»ä¸‹è½½ URI å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨ URI..."

    if ! download_file "${backup_down_uri}"; then
        echoYellow "å¤‡ç”¨ä¸‹è½½ URI ä¹Ÿå¤±è´¥äº†ï¼"
        exit 1
    fi
fi


##################################################################
## Add environment variables
##################################################################
NEW_PATH="/os/bin/"
BASHRC_FILE="/etc/bash.bashrc"
sudo sed -i "\|export PATH=.*${NEW_PATH}|d" ${BASHRC_FILE}
echo "export PATH=${NEW_PATH}:\$PATH" | sudo tee -a ${BASHRC_FILE} > /dev/null

##################################################################
## ttyd
##################################################################
# æ£€æŸ¥ ss æ˜¯å¦å¯ç”¨ï¼Œä¸å¯ç”¨åˆ™å°è¯•å®‰è£…
if ! command -v ss >/dev/null 2>&1; then
    echo "ðŸ› ï¸ ss ä¸å­˜åœ¨ï¼Œå°è¯•å®‰è£… iproute2..."
    if command -v apt >/dev/null 2>&1; then
        sudo apt update && sudo apt install -y iproute2
    fi
fi

# å†æ¬¡æ£€æŸ¥ ss æ˜¯å¦å¯ç”¨
if command -v ss >/dev/null 2>&1; then
    if ss -lntp | grep -q ":4200"; then
        echo "ttyd is already running"
    else
        cp /os/service/os-ttyd.service /etc/systemd/system/
        systemctl daemon-reload
        systemctl enable os-ttyd.service
        systemctl restart os-ttyd.service
    fi
fi


echoCyan "------------------------------------------------------------------ Update successful."
